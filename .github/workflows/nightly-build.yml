name: Nightly Build and Analysis

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - board: hcbb22e
            config: prj-smpsvr.conf
            overlay: nrf52832dk.overlay
          - board: hcbb22e
            config: prj-smpsvr-lowpower.conf
            overlay: nrf52832dk.overlay
          - board: kkm_c2_nrf82805
            config: prj.conf
            overlay: ""
          - board: kkm_c2_nrf82805
            config: prj-lowpower.conf
            overlay: ""
          - board: kkm_k4p
            config: prj-smpsvr.conf
            overlay: ""
          - board: kkm_k4p
            config: prj-smpsvr-lowpower.conf
            overlay: ""
          # nRF52810 boards - Using minimal config (no MCUboot)
          - board: kkm_p1_nrf52810
            config: prj-nrf52810-lowmem.conf
            overlay: ""
          - board: kkm_p11_nrf52810
            config: prj-nrf52810-lowmem.conf
            overlay: ""
          # DISABLED: nRF52805 boards - Likely insufficient FLASH
          #   - board: nrf52805_evm
          #     config: prj.conf
          #     overlay: ""
          #   - board: nrf52805_evm
          #     config: prj-lowpower.conf
          #     overlay: ""
          - board: wb_20241007
            config: prj.conf
            overlay: ""
          - board: wb_20241125
            config: prj.conf
            overlay: ""
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y \
            git cmake ninja-build gperf ccache \
            dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools \
            python3-tk python3-wheel xz-utils file make \
            gcc gcc-multilib g++-multilib libsdl2-dev libmagic1
          pip3 install west

      - name: Cache NCS workspace
        id: cache-ncs
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/ncs-workspace
          key: ncs-v2.8.0-${{ runner.os }}-cache
          restore-keys: ncs-v2.8.0-${{ runner.os }}

      - name: Cache Zephyr SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ~/zephyr-sdk-0.16.8
          key: zephyr-sdk-0.16.8-${{ runner.os }}

      - name: Install Zephyr SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          rm zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Set up Zephyr SDK environment
        run: |
          echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.16.8" >> $GITHUB_ENV
          echo "ZEPHYR_TOOLCHAIN_VARIANT=zephyr" >> $GITHUB_ENV

      - name: Set up nRF Connect SDK (cached)
        if: steps.cache-ncs.outputs.cache-hit == 'true'
        run: |
          echo "ZEPHYR_BASE=${{ runner.temp }}/ncs-workspace/zephyr" >> $GITHUB_ENV
          echo "PYTHONPATH=${{ runner.temp }}/ncs-workspace:$PYTHONPATH" >> $GITHUB_ENV
          echo "Using cached NCS workspace"

      - name: Set up nRF Connect SDK (fresh)
        if: steps.cache-ncs.outputs.cache-hit != 'true'
        run: |
          # Create workspace directory
          mkdir -p ${{ runner.temp }}/ncs-workspace
          cd ${{ runner.temp }}/ncs-workspace
          
          # Initialize west workspace with minimal modules
          west init -m https://github.com/nrfconnect/sdk-nrf.git --mr v2.8.0
          
          # Update with aggressive shallow cloning
          west update --narrow --fetch-opt=--depth=1 -o=--depth=1 --group-filter=-optional
          
          # Install Python requirements
          pip3 install -r zephyr/scripts/requirements.txt
          
          # Export paths
          echo "ZEPHYR_BASE=${{ runner.temp }}/ncs-workspace/zephyr" >> $GITHUB_ENV
          echo "PYTHONPATH=${{ runner.temp }}/ncs-workspace:$PYTHONPATH" >> $GITHUB_ENV

      - name: Clean previous builds
        run: rm -rf $GITHUB_WORKSPACE/build-* && ls -la

      - name: Build firmware - ${{ matrix.board }} (${{ matrix.config }})
        id: build
        run: |
          # Set up build environment
          cd ${{ runner.temp }}/ncs-workspace
          source zephyr/zephyr-env.sh
          
          BUILD_DIR="$GITHUB_WORKSPACE/build-${{ matrix.board }}-${{ matrix.config }}"
          
          echo "::group::Building for ${{ matrix.board }} with ${{ matrix.config }}"
          
          # Build configuration
          OVERLAY_ARGS=""
          if [ ! -z "${{ matrix.overlay }}" ]; then
            OVERLAY_ARGS="-DEXTRA_DTC_OVERLAY_FILE=$GITHUB_WORKSPACE/${{ matrix.overlay }}"
          fi
          
          west build -b ${{ matrix.board }} \
            -s $GITHUB_WORKSPACE \
            -d "$BUILD_DIR" \
            -- -DBOARD_ROOT=$GITHUB_WORKSPACE \
            -DCONF_FILE=$GITHUB_WORKSPACE/${{ matrix.config }} \
            $OVERLAY_ARGS 2>&1 | tee $GITHUB_WORKSPACE/build.log
          
          echo "::endgroup::"
          
          if [ -f "$BUILD_DIR/zephyr/zephyr.hex" ]; then
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "BUILD_SIZE=$(stat -f%z "$BUILD_DIR/zephyr/zephyr.hex" 2>/dev/null || stat -c%s "$BUILD_DIR/zephyr/zephyr.hex")" >> $GITHUB_OUTPUT
          else
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate build report
        if: always()
        run: |
          BUILD_DIR="$GITHUB_WORKSPACE/build-${{ matrix.board }}-${{ matrix.config }}"
          echo "## Build Report: ${{ matrix.board }} - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.build.outputs.BUILD_SUCCESS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outputs.BUILD_SUCCESS }}" = "true" ]; then
            echo "### Output Files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh "$BUILD_DIR/zephyr/" | grep -E "\.(hex|bin|elf)$" >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "$BUILD_DIR/zephyr/zephyr.hex" ]; then
              SIZE=$(stat -c%s "$BUILD_DIR/zephyr/zephyr.hex" 2>/dev/null || stat -f%z "$BUILD_DIR/zephyr/zephyr.hex")
              echo "**Firmware Size:** $SIZE bytes" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.board }}-${{ matrix.config }}
          path: ${{ github.workspace }}/build.log
          retention-days: 7

      - name: Upload firmware on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-firmware-${{ matrix.board }}-${{ matrix.config }}
          path: ${{ github.workspace }}/build-${{ matrix.board }}-${{ matrix.config }}/zephyr/
          retention-days: 7

  summary:
    needs: build-all
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Nightly Build Summary" > summary.md
          echo "" >> summary.md
          echo "**Date:** $(date -u)" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "" >> summary.md
          
          SUCCESS_COUNT=$(find . -type d -name "nightly-firmware-*" | wc -l)
          FAIL_COUNT=$(find . -type f -name "build.log" | wc -l)
          
          echo "## Results" >> summary.md
          echo "- ✓ Successful builds: $SUCCESS_COUNT" >> summary.md
          echo "- ✗ Failed builds: $FAIL_COUNT" >> summary.md
          echo "" >> summary.md
          
          echo "## Build Artifacts" >> summary.md
          echo "\`\`\`" >> summary.md
          ls -lhR nightly-firmware-* 2>/dev/null || echo "No successful builds" >> summary.md
          echo "\`\`\`" >> summary.md
          
          cat summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: nightly-build-summary
          path: summary.md
          retention-days: 30
