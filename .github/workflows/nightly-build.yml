name: Nightly Build and Analysis

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - board: hcbb22e
            config: prj-smpsvr.conf
            overlay: nrf52832dk.overlay
          - board: hcbb22e
            config: prj-smpsvr-lowpower.conf
            overlay: nrf52832dk.overlay
          - board: kkm_c2_nrf82805
            config: prj.conf
            overlay: ""
          - board: kkm_c2_nrf82805
            config: prj-lowpower.conf
            overlay: ""
          - board: kkm_k4p
            config: prj-smpsvr.conf
            overlay: ""
          - board: kkm_k4p
            config: prj-smpsvr-lowpower.conf
            overlay: ""
          - board: kkm_p1_nrf52810
            config: prj.conf
            overlay: ""
          - board: kkm_p1_nrf52810
            config: prj-lowpower.conf
            overlay: ""
          - board: kkm_p11_nrf52810
            config: prj.conf
            overlay: ""
          - board: kkm_p11_nrf52810
            config: prj-lowpower.conf
            overlay: ""
          - board: nrf52805_evm
            config: prj.conf
            overlay: ""
          - board: nrf52805_evm
            config: prj-lowpower.conf
            overlay: ""
          - board: wb_20241007
            config: prj.conf
            overlay: ""
          - board: wb_20241125
            config: prj.conf
            overlay: ""
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up nRF Connect SDK
        uses: nrfconnect/action-nrf-connect-sdk@main
        with:
          ncs-version: v2.8.0

      - name: Clean previous builds
        run: rm -rf build-* && ls -la

      - name: Build firmware - ${{ matrix.board }} (${{ matrix.config }})
        id: build
        run: |
          cd $GITHUB_WORKSPACE
          BUILD_DIR="build-${{ matrix.board }}-${{ matrix.config }}"
          
          echo "::group::Building for ${{ matrix.board }} with ${{ matrix.config }}"
          
          west build -b ${{ matrix.board }} \
            -c ${{ matrix.config }} \
            --build-dir "$BUILD_DIR" \
            -- -DEXTRA_DTC_OVERLAY_FILE=${{ matrix.overlay }} 2>&1 | tee build.log
          
          echo "::endgroup::"
          
          if [ -f "$BUILD_DIR/zephyr/zephyr.hex" ]; then
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "BUILD_SIZE=$(stat -f%z "$BUILD_DIR/zephyr/zephyr.hex" 2>/dev/null || stat -c%s "$BUILD_DIR/zephyr/zephyr.hex")" >> $GITHUB_OUTPUT
          else
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate build report
        if: always()
        run: |
          BUILD_DIR="build-${{ matrix.board }}-${{ matrix.config }}"
          echo "## Build Report: ${{ matrix.board }} - ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.build.outputs.BUILD_SUCCESS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outputs.BUILD_SUCCESS }}" = "true" ]; then
            echo "### Output Files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh "$BUILD_DIR/zephyr/" | grep -E "\.(hex|bin|elf)$" >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "$BUILD_DIR/zephyr/zephyr.hex" ]; then
              SIZE=$(stat -c%s "$BUILD_DIR/zephyr/zephyr.hex" 2>/dev/null || stat -f%z "$BUILD_DIR/zephyr/zephyr.hex")
              echo "**Firmware Size:** $SIZE bytes" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.board }}-${{ matrix.config }}
          path: build.log
          retention-days: 7

      - name: Upload firmware on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-firmware-${{ matrix.board }}-${{ matrix.config }}
          path: build-${{ matrix.board }}-${{ matrix.config }}/zephyr/
          retention-days: 7

  summary:
    needs: build-all
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Nightly Build Summary" > summary.md
          echo "" >> summary.md
          echo "**Date:** $(date -u)" >> summary.md
          echo "**Commit:** ${{ github.sha }}" >> summary.md
          echo "" >> summary.md
          
          SUCCESS_COUNT=$(find . -type d -name "nightly-firmware-*" | wc -l)
          FAIL_COUNT=$(find . -type f -name "build.log" | wc -l)
          
          echo "## Results" >> summary.md
          echo "- ✓ Successful builds: $SUCCESS_COUNT" >> summary.md
          echo "- ✗ Failed builds: $FAIL_COUNT" >> summary.md
          echo "" >> summary.md
          
          echo "## Build Artifacts" >> summary.md
          echo "\`\`\`" >> summary.md
          ls -lhR nightly-firmware-* 2>/dev/null || echo "No successful builds" >> summary.md
          echo "\`\`\`" >> summary.md
          
          cat summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: nightly-build-summary
          path: summary.md
          retention-days: 30
